{% extends "base.html" %}

{% block content %}

    <h1>Visualizador de puntos de parada</h1>

    <div class="formulario">
        <h2>Subir ficheros CSV</h2>

        <div class="file-section two-columns">
            <div class="column">
                <div class="file-A-section">
                    <form method="POST" action="{{ url_for('fileUpload.uploadFileAToBackend') }}" enctype="multipart/form-data">
                        <label for="fileA">Seleccione el fichero A</label>
                        <input type="file" name="fileA" accept=".csv" id="fileA-input" required><br><br>
                        <input type="submit" value="Cargar Fichero A" disabled title="Se debe seleccionar un fichero"><br><br><br><br>
                        <textarea name="fileA-logs" id="fileA-logs" placeholder="Esperando un fichero A..." disabled></textarea>
                    </form>
                </div>
            </div>
            <div class="column">
                <div class="file-BC-section">
                    <form method="POST" action="{{ url_for('fileUpload.uploadFilesBCToBackend') }}" enctype="multipart/form-data">
                        <label for="fileB">Seleccione el fichero B</label>
                        <input type="file" name="fileB" accept=".csv" id="fileB-input" required><br><br>
                        <label for="fileC">Seleccione el fichero C</label>
                        <input type="file" name="fileC" accept=".csv" id="fileC-input" required><br><br>
                        <input type="submit" value="Cargar Ficheros B y C" disabled title="Se deben seleccionar los dos ficheros"><br><br>
                        <textarea name="fileBC-logs" id="fileBC-logs" placeholder="Esperando ficheros B y C..." disabled></textarea>
                    </form>
                </div>
            </div>
        </div>
        <button class="accept-btn" id="estadisticasBtn" disabled>Descargar estad铆sticas</button>
    </div>
    <br>

    {% if session.get('uploaded_files') %}
    <div class="uploaded-files">
        <h2> Ficheros cargados en sesi贸n</h2>
        <ul>
            {% for key, path in session['uploaded_files'].items() %}
                <li><strong>{{ key }}:</strong> {{ path.replace('\\', '/').split('/')[-1] }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}


    <h2>Generar tabla y mapa</h2>
    <form action="{{ url_for('generateResults.generar_mapa') }}" method="get">
        <button type="submit" class="generate-btn" id="mapaBtn">Ver mapa</button>
    </form><br>
    <form action="{{ url_for('generateResults.unifyFiles') }}" method="get">
        <h2>Unificar ficheros</h2>
        <input type="text" name="codiredMain" id="codiredMain" class="codiredMain" placeholder="Codired" minlength="7" maxlength="7" required>
        <button type="submit" class="generate-btn" id="unifyBtn" disabled>Unificar todos los ficheros</button>
    </form>


    <h2>Sesi贸n</h2>
    <form action="{{ url_for('main.logout') }}" method="get" onsubmit="return confirmLogout();">
        <button type="submit" class="logout-btn">Limpiar sesi贸n</button>
    </form>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // comprobar si los ficheros estan o no
            checkFiles().then(areFiles => {
                enableBtns(areFiles);
            });

            // --- FORM A ---
            const formA = document.querySelector('form[action*="uploadFileAToBackend"]');
            const inputA = formA.querySelector('input[name="fileA"]');
            const submitA = formA.querySelector('input[type="submit"]');
            inputA.addEventListener('change', () => {
                submitA.disabled = inputA.files.length === 0;
                submitA.title = submitA.disabled ? "Se debe seleccionar un fichero" : "";
            });

            // --- FORM B+C ---
            const formBC = document.querySelector('form[action*="uploadFilesBCToBackend"]');
            const inputB = formBC.querySelector('input[name="fileB"]');
            const inputC = formBC.querySelector('input[name="fileC"]');
            const submitBC = formBC.querySelector('input[type="submit"]');
            function checkBC() {
                const ready = inputB.files.length > 0 && inputC.files.length > 0;
                submitBC.disabled = !ready;
                submitBC.title = ready ? "" : "Se deben seleccionar los dos ficheros";
            }
            inputB.addEventListener('change', checkBC);
            inputC.addEventListener('change', checkBC);

            // --- FORM A+B+C ---
            /*
            const formABC = document.querySelector('form[action*="uploadFileToBackend"]');
            const inputsABC = formABC.querySelectorAll('input[type="file"]');
            const submitABC = formABC.querySelector('input[type="submit"]');
            function checkABC() {
                const ready = Array.from(inputsABC).every(input => input.files.length > 0);
                submitABC.disabled = !ready;
                submitABC.title = ready ? "" : "Se deben seleccionar los tres ficheros";
            }
            inputsABC.forEach(input => input.addEventListener('change', checkABC));
            */


           /*
           // Descargar el fichero con estad铆sticas
            document.getElementById("estadisticasBtn").addEventListener("click", async () => {
                const link = document.createElement("a");
                link.href = "ruta";
                link.download = "Estad铆sticasUni贸nFicheros.pdf";
                link.click();
            });
            */
        });

        // Confirm logout
        function confirmLogout() {
            return confirm("驴Seguro que deseas cerrar la sesi贸n y eliminar los ficheros subidos?");
        }

        // Comprobar si se han subido todos los archivos
        function checkFiles() {
            return fetch("/check_files_status", {
                method: "POST"
            })
            .then(response => response.json())
            .then(data => data.ready)
            .catch(err => {
                console.error("Error comprobando archivos:", err);
                return false; // fallback
            });
        }

        function enableBtns(areFiles) {
            const estadisticasBtn = document.getElementById("estadisticasBtn");
            const mapaBtn = document.getElementById("mapaBtn");
            const unifyBtn = document.getElementById("unifyBtn");
            if (areFiles === true) {
                estadisticasBtn.disabled = false;
                //mapaBtn.disabled = false;
                unifyBtn.disabled = false;
            } else {
                estadisticasBtn.disabled = true;
                //mapaBtn.disabled = true;
                unifyBtn.disabled = true;
            }
        }

        // Ajax for file A upload
        document
            .querySelector('form[action*="uploadFileAToBackend"]')
            .addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const res = await fetch(e.target.action, { method: 'POST', body: formData });
                const data = await res.json();
                document.getElementById('fileA-logs').value = data.logs;
                checkFiles().then(areFiles => {
                    enableBtns(areFiles);
                });
        });
        // Ajax for files B and C upload
        document
            .querySelector('form[action*="uploadFilesBCToBackend"]')
            .addEventListener('submit', async (e) => {
                e.preventDefault(); // stop normal form submission

                const formData = new FormData(e.target);
                const res = await fetch(e.target.action, { method: 'POST', body: formData });
                const data = await res.json();

                // Display logs in the textarea
                document.getElementById('fileBC-logs').value = data.logs;
                checkFiles().then(areFiles => {
                    enableBtns(areFiles);
                });
        });

        document.getElementById("estadisticasBtn").addEventListener("click", async () => {
            try {
                // Llamada al endpoint de tu API que a su vez llama a descargar_estadisticas
                const response = await fetch("/getStadistics", {
                    method: "GET",
                });

                if (!response.ok) {
                    throw new Error("Error al descargar el PDF");
                }

                // Convertir la respuesta a Blob (tipo archivo)
                const blob = await response.blob();

                // Crear URL temporal
                const url = window.URL.createObjectURL(blob);

                // Crear enlace temporal para forzar la descarga
                const a = document.createElement("a");
                a.href = url;
                a.download = "estadisticas.pdf";  // Nombre del archivo que ver谩 el usuario
                document.body.appendChild(a);
                a.click();

                // Limpiar
                a.remove();
                window.URL.revokeObjectURL(url);

            } catch (error) {
                console.error(error);
                alert("No se pudo descargar el PDF");
            }
        });


    </script>
{% endblock %}