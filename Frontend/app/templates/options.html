{% extends "base.html" %}

{% block content %}

    <form action="{{ url_for('main.root') }}" method="get">
        <button type="submit">Volver</button>
    </form>

    <div>
        <form id="forms" method="POST" action="/procesar_mapa" onsubmit="return validarFormulario();">
            <h2>Seleccionar PDA</h2>
            <select name="pda" id="pda" size="6">
                <option value="TODAS">Todas</option>
                {% for pda in pdas %}
                    <option value="{{ pda }}">{{ pda }}</option>
                {% endfor %}
            </select>
            <br><br>

            <h2>Seleccionar Fechas</h2>
            <label for="fechaInicio">Fecha de inicio:</label>
            <select name="fecha_inicio" id="fechaInicio"></select>

            <label for="fechaFin">Fecha de final:</label>
            <select name="fecha_fin" id="fechaFin"></select>
            <br><br><br>

            <button type="submit">Generar</button>
        </form>

        <script>
            const pdaSelect = document.getElementById('pda');
            const fechaInicio = document.getElementById('fechaInicio');
            const fechaFin = document.getElementById('fechaFin');

            pdaSelect.addEventListener('change', function () {
                const pda = this.value;

                if (!pda) {
                    fechaInicio.innerHTML = '';
                    fechaFin.innerHTML = '';
                    return;
                }

                fetch(`/fechas_por_pda?pda=${encodeURIComponent(pda)}`)
                    .then(response => response.json())
                    .then(data => {
                        fechaInicio.innerHTML = '';
                        fechaFin.innerHTML = '';
                        data.fechas.forEach(fecha => {
                            const opt1 = document.createElement('option');
                            const opt2 = document.createElement('option');
                            opt1.value = opt2.value = fecha;
                            opt1.text = opt2.text = fecha;
                            fechaInicio.appendChild(opt1);
                            fechaFin.appendChild(opt2);
                        });
                    });
            });

            function validarFormulario() {
                const ini = fechaInicio.value;
                const fin = fechaFin.value;

                if (!ini || !fin) {
                    alert("Debes seleccionar una fecha de inicio y de fin.");
                    return false;
                }

                if (ini >= fin) {
                    alert("La fecha de fin debe ser mayor que la de inicio.");
                    return false;
                }

                return true;
            }
        </script>
    </div>


{% endblock %}