{% extends "base.html" %}

{% block content %}

    <form action="{{ url_for('main.root') }}" method="get">
        <button type="submit" class="logout-btn">Volver</button>
    </form>

    <div class="section">
        <div class="column">
            <div class="contenedor">
                <form id="forms" class="formulario" method="POST" onsubmit="return validarFormulario();">
                    <h2>Seleccionar</h2>
                    <div class="custom-select">
                        <button type="button" class="select-btn" id="pdaBtn">Selecciona una PDA</button>
                        <div class="options" id="pdaOptions">
                            <!--
                            <div data-value="TODAS">Todas</div>
                            -->
                            {% for pda in pdas %}
                                <div data-value="{{ pda }}">{{ pda }}</div>
                            {% endfor %}
                        </div>
                    </div>

                    <div id="waitMessage"></div>

                    <br><br>
                    
                    <input type="hidden" name="pda" id="pdaInput">
                    
                    <h2>Seleccionar</h2>
                    <label>Fecha de inicio:</label>
                    <input type="date" name="fecha_inicio" id="fechaInicio" disabled>
                    
                    <br>
                    
                    <label>Fecha de fin: (no )</label>
                    <input type="date" name="fecha_fin" id="fechaFin" disabled>
                    <br>
                    
                    <small id="fechaAviso" style="color: red; display: none;">⚠️ Fecha fuera de los datos disponibles</small>
                    
                    <br><br>
                    
                    <button type="submit" class="generate-btn">Generar tabla</button>
                </form>
            </div>
        </div>


        <div class="double-column">
            <div class="contenedor">
                <div class="tabla-resumen">
                    <table>
                        <tr><th colspan="2">Tabla resumen</th></tr>
                        <tr><td>Puntos totales:</td><td id="res-puntos">—</td></tr>
                        <tr><td>Distancia total:</td><td id="res-distancia">—</td></tr>
                        <tr><td>Tiempo total:</td><td id="res-tiempo">—</td></tr>
                        <tr><td>Velocidad media:</td><td id="res-velocidad">—</td></tr>
                    </table>
                </div>
            </div>
            
            <div class="contenedor">
                <div class="tabla-filtros">
                    <h3>Filtros</h3>
                    <label for="filtro-distancia">Distancia:</label>
                    <select class="select-sign-btn" name="distancia-signo" id="distancia-signo">
                        <option value="menor">&lt;</option>
                        <option value="menor-igual">&le;</option>
                        <option value="igual">=</option>
                        <option value="no-igual">&ne;</option>
                        <option value="mayor">&gt;</option>
                        <option value="mayor-igual">&ge;</option>
                    </select>
                    <input type="number" name="filtroDistancia" id="filtroDistancia" placeholder="Distancia">
                    <br><br>
                    <label for="filtro-tiempo">Tiempo:</label>
                    <select class="select-sign-btn" name="tiempo-signo" id="tiempo-signo">
                        <option value="menor">&lt;</option>
                        <option value="menor-igual">&le;</option>
                        <option value="igual">=</option>
                        <option value="no-igual">&ne;</option>
                        <option value="mayor">&gt;</option>
                        <option value="mayor-igual">&ge;</option>
                    </select>
                    <input type="number" name="filtroTiempo" id="filtroTiempo" placeholder="Tiempo">
                    <br><br>
                    <label for="filtro-velocidad">Velocidad:</label>
                    <select class="select-sign-btn" name="velocidad-signo" id="velocidad-signo">
                        <option value="menor">&lt;</option>
                        <option value="menor-igual">&le;</option>
                        <option value="igual">=</option>
                        <option value="no-igual">&ne;</option>
                        <option value="mayor">&gt;</option>
                        <option value="mayor-igual">&ge;</option>
                    </select>
                    <input type="number" name="filtroVelocidad" id="filtroVelocidad" placeholder="Velocidad">
                    <br><br>
                    <button class="accept-btn" onclick="filtrarTabla()">Filtrar</button>
                </div>
            </div>
        </div>


        <div class="column">
            <!-- Mapa -->
            <div class="map" id="mapa">
                <h2>Mapa</h2>
                <iframe src="" frameborder="0"></iframe>
            </div>
        </div>
    </div>


    <div id="tabla-resultados" style="display:none;">
        <h2>Resultados — <span id="titulo-pda"></span> (<span id="titulo-fecha"></span>)</h2>

        <table id="tablaDatos">
            <thead>
                <tr>
                    <th>nº punto</th>
                    <th>hora</th>
                    <th>longitud</th>
                    <th>latitud</th>
                    <th>distancia</th>
                    <th>tiempo</th>
                    <th>velocidad</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div id="paginador" style="display:none; justify-content:center; align-items:center; gap:10px; margin-top:10px;">
            <button id="btn-prev" onclick="if(paginaActual>1){paginaActual--; renderPagina(paginaActual);}">Anterior</button>
            <span id="pagina-info">Página 1 de 1</span>
            <button id="btn-next" onclick="if(paginaActual<Math.ceil(tablaDatos.length/filasPorPagina)){paginaActual++; renderPagina(paginaActual);}">Siguiente</button>
        </div>

    </div>

    <script>
        // --------- SELECT PERSONALIZADO ---------
        const selectBtn = document.getElementById('pdaBtn');
        const options = document.getElementById('pdaOptions');
        const pdaInput = document.getElementById('pdaInput');
        const waitMessage = document.getElementById('waitMessage');
        const fechaInicio = document.getElementById('fechaInicio');
        const fechaFin = document.getElementById('fechaFin');
        const aviso = document.getElementById('fechaAviso');

        let fechasDisponibles = new Set();

        selectBtn.addEventListener('click', () => {
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
        });

        // Al seleccionar PDA:
        options.querySelectorAll('div').forEach(opt => {
            opt.addEventListener('click', () => {
                selectBtn.textContent = opt.textContent;
                pdaInput.value = opt.getAttribute('data-value');
                options.style.display = 'none';

                // Mostrar mensaje de espera al usuario
                waitMessage.textContent = 'Procesando fechas válidas.';
                waitMessage.style.display = 'block';
                
                // Bloquear campos y limpiar valores
                fechaInicio.disabled = true;
                fechaFin.disabled = true;
                fechaInicio.value = "";
                fechaFin.value = "";
                aviso.style.display = "none";
                fechasDisponibles.clear();

                // Obtener fechas disponibles desde el backend
                fetch(`/fechas_por_pda?pda=${encodeURIComponent(pdaInput.value)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.fechas && data.fechas.length > 0) {
                            fechaInicio.disabled = false;
                            fechaFin.disabled = true;

                            // Guardamos fechas válidas
                            fechasDisponibles = new Set(data.fechas);

                            // Ajustar límites del calendario
                            fechaInicio.setAttribute("min", data.fechas[0]);
                            fechaInicio.setAttribute("max", data.fechas[data.fechas.length - 1]);
                            fechaFin.setAttribute("min", data.fechas[0]);
                            fechaFin.setAttribute("max", data.fechas[data.fechas.length - 1]);
                        }
                    })
                    .catch(error => {
                        // Mostrar mensaje de error al usuario
                        waitMessage.textContent = 'Error al cargar las fechas.'
                    })
                    .finally(() => {
                        // Ocultar mensaje de espera al usuario
                        waitMessage.style.display = 'none';
                    });
            });
        });

        // --------- VALIDACIÓN DE FECHAS ---------
        function validarFecha(campo) {
            const fecha = campo.value;
            if (fecha === "") return;

            if (!fechasDisponibles.has(fecha)) {
                aviso.style.display = "inline";
                campo.style.borderColor = "red";
                campo.style.backgroundColor = "#ffecec";
            } else {
                aviso.style.display = "none";
                campo.style.borderColor = "#ccc";
                campo.style.backgroundColor = "";
            }
        }

        fechaInicio.addEventListener("change", () => validarFecha(fechaInicio));
        fechaFin.addEventListener("change", () => validarFecha(fechaFin));

        // --------- PAGINACIÓN Y RENDERIZADO ---------
        let tablaDatos = [];
        let paginaActual = 1;
        const filasPorPagina = 50;

        function renderPagina(pagina) {
            const tbody = document.querySelector('#tablaDatos tbody');
            tbody.innerHTML = "";

            const inicio = (pagina - 1) * filasPorPagina;
            const fin = inicio + filasPorPagina;
            const fragment = document.createDocumentFragment();

            const filas = tablaDatos.slice(inicio, fin);
            filas.forEach(fila => {
                const tr = document.createElement('tr');
                const celdas = [
                    fila.n,
                    fila.hora,
                    fila.longitud,
                    fila.latitud,
                    fila.distancia,
                    fila.tiempo,
                    fila.velocidad
                ];
                celdas.forEach(valor => {
                    const td = document.createElement('td');
                    td.textContent = valor ?? '';
                    tr.appendChild(td);
                });
                fragment.appendChild(tr);
            });

            tbody.appendChild(fragment);

            // Actualizar el texto del paginador
            document.getElementById('pagina-info').textContent =
                `Página ${pagina} de ${Math.ceil(tablaDatos.length / filasPorPagina)}`;

            // Desactivar botones si es necesario
            document.getElementById('btn-prev').disabled = pagina === 1;
            document.getElementById('btn-next').disabled = pagina >= Math.ceil(tablaDatos.length / filasPorPagina);
        }

        // --------- VALIDACIÓN DEL FORMULARIO ---------
        function validarFormulario() {
            const pda = pdaInput.value;
            const ini = fechaInicio.value;
            const fin = fechaFin.value;

            if (!pda) {
                alert("Debes seleccionar una PDA.");
                return false;
            }
            if (!ini) {
                alert("Debes seleccionar una fecha de inicio.");
                return false;
            }

            fetch('/generar_mapa/datos_tabla', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pda, ini })
            })
            .then(response => {
                if (!response.ok) throw new Error("Error al obtener los datos del servidor");
                return response.json();
            })
            .then(data => {
                // === Actualizar los resultados del resumen ===
                const resumen = data.resumen;
                document.getElementById('res-puntos').textContent = resumen.puntos_totales;
                document.getElementById('res-distancia').textContent = resumen.distancia_total;
                document.getElementById('res-tiempo').textContent = resumen.tiempo_total;
                document.getElementById('res-velocidad').textContent = resumen.velocidad_media;

                // === Actualizar los títulos ===
                document.getElementById('titulo-pda').textContent = pda;
                document.getElementById('titulo-fecha').textContent = ini + (fin ? " → " + fin : "");

                // === Guardar los datos globalmente y renderizar ===
                tablaDatos = data.tabla;
                paginaActual = 1;
                renderPagina(paginaActual);

                // === Mostrar la tabla y los controles de paginación ===
                document.getElementById('tabla-resultados').style.display = 'block';
                document.getElementById('paginador').style.display = 'flex';
            })
            .catch(err => {
                console.error(err);
                alert("Ocurrió un error al procesar la solicitud.");
            });

            return false;
        }

        // --------- FILTROS ---------
        function extraerNum(text) {
            const num = text.match(/[\d\.]+/);
            return num ? parseFloat(num[0]) : null;
        }

        function cumpleCondicion(val, comp, ref) {
            if(comp == "menor") return val < ref;
            if(comp == "menor-igual") return val <= ref;
            if(comp == "igual") return val === ref;
            if(comp == "no-igual") return val != ref;
            if(comp == "mayor") return val > ref;
            if(comp == "mayor-igual") return val >= ref;
            return true;
        }

        function filtrarTabla() {
            const rows = document.querySelectorAll('#tablaDatos tbody tr');

            const filtros = [
                {
                    comparador: document.getElementById("distancia-signo").value,
                    valor: parseFloat(document.getElementById("filtroDistancia").value),
                    columna: 4
                },
                {
                    comparador: document.getElementById("tiempo-signo").value,
                    valor: parseFloat(document.getElementById("filtroTiempo").value),
                    columna: 5
                },
                {
                    comparador: document.getElementById("velocidad-signo").value,
                    valor: parseFloat(document.getElementById("filtroVelocidad").value),
                    columna: 6
                }
            ];


            rows.forEach(row => {
                let mostrar = true;

                filtros.forEach(filtro => {
                    if(!isNaN(filtro.valor)) {
                        const text = row.cells[filtro.columna].textContent.trim();
                        const num = extraerNum(text);
                        if(!cumpleCondicion(num, filtro.comparador, filtro.valor)) {
                            mostrar = false;
                        }
                    }
                });
    
                row.style.display = mostrar ? '' : 'none';
            });
        }
    </script>

{% endblock %}