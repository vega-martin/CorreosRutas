{% extends "base.html" %}

{% block content %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/static/js/options.js"></script>

    <form action="{{ url_for('main.root') }}" method="get">
        <button type="submit" class="logout-btn">
            Volver
        </button>
    </form>

    <!-- Página de opciones completa -->
    <div class="section">

        <!-- Formulario para introducir código de unidad, seleccionar PDA y fecha -->
        <div class="column">
            <div class="contenedor">
                <form id="forms" class="formulario" method="POST">

                    <h2>Introducir código de unidad</h2>
                    <div class="custom-select">
                        <button type="button" class="select-btn" id="codiredBtn">Selecciona un código de unidad</button>
                        <div class="options" id="codiredOptions">
                            <!-- Las opciones se llenan dinámicamente con JavaScript -->
                        </div>
                    </div>

                    <input type="hidden" name="codired" id="codiredInput">

                    <label class="disabled-blue-label" for="btn-nuevo-geojson" id="label-nuevo-geojson" >
                        Nuevo GeoJSON
                    </label><br>
                    <input type="file" id="btn-nuevo-geojson" name="btn-nuevo-geojson" accept=".geojson" style="display: none;">

                    <p id="usar-geojson" style="display: none; color: #1e587e;">
                        Ya hay un GeoJson cargado para ese código de unidad.<br>Si no se sube un fichero nuevo se usará ese.
                    </p>
                    <p id="msj-nuevo-geojson" style="display: none; color: #1e587e;">
                        Nuevo GeoJSON subido correctamente.
                    </p>

                    <h2>Seleccionar PDA</h2>
                    <div class="custom-select">
                        <button type="button" class="select-btn" id="pdaBtn" disabled>Selecciona una PDA</button>
                        <div class="options" id="pdaOptions">
                            <!-- Las opciones se llenan dinámicamente con JavaScript -->
                        </div>
                    </div>

                    <div id="waitMessage"></div>

                    
                    <input type="hidden" name="pda" id="pdaInput">
                    
                    <h2>Seleccionar fecha</h2>
                    <label>Fecha de inicio:</label>
                    <input type="date" name="fecha_inicio" id="fechaInicio" disabled>
                    
                    <br>
                    
                    <label>Fecha de fin:</label>
                    <input type="date" name="fecha_fin" id="fechaFin" disabled>
                    <br>
                    
                    <small id="fechaAviso" style="color: red; display: none;">⚠️ Fecha fuera de los datos disponibles</small>
                    
                    <br><br>
                    
                    <button type="submit" class="generate-btn" id="generate-btn">
                        Generar tabla
                    </button>
                    <br><br>

                    <!-- Seleccion metodo de agrupamiento -->
                    <div class="custom-select">
                        <button type="button" class="select-btn" id="agrupamientoBtn" disabled>Selecciona metodo de agrupamiento</button>
                        <div class="options" id="agrupamientoOptions">
                             <div data-value="tiempo">Por tiempo</div>
                            <div data-value="diametro">Por diámetro</div>
                        </div>
                    </div>
                    <input type="hidden" name="agrupamiento" id="agrupamientoInput">
                    <button type="button" class="accept-btn" id="btn-agrupar-general" disabled>
                        Agrupar
                    </button>
                </form>
            </div>
        </div>

        <!-- Tabla de resultados y tabla de filtros -->
        <div class="double-column">

            <!-- Tabla de resumen -->
            <div class="contenedor">
                <div class="tabla-resumen">
                    <table>
                        <tr><th colspan="2">Tabla resumen</th></tr>
                        <tr><td>Puntos totales:</td><td id="res-puntos">—</td></tr>
                        <tr><td>Distancia total:</td><td id="res-distancia">—</td></tr>
                        <tr><td>Tiempo total:</td><td id="res-tiempo">—</td></tr>
                        <tr><td>Velocidad media:</td><td id="res-velocidad">—</td></tr>
                        <tr><td>Tiempo de ejecución total:</td><td id="res-t-ejecucion">—</td></tr>
                    </table>
                </div>
            </div>
            
            <!-- Tabla de filtros -->
            <div class="contenedor">
                <div class="tabla-filtros">
                    <h3>Filtros</h3>
                    <label for="filtro-distancia">Distancia:</label>
                    <select class="select-sign-btn" name="distancia-signo" id="distancia-signo">
                        <option value="menor">&lt;</option>
                        <option value="menor-igual">&le;</option>
                        <option value="igual">=</option>
                        <option value="no-igual">&ne;</option>
                        <option value="mayor">&gt;</option>
                        <option value="mayor-igual">&ge;</option>
                    </select>
                    <input type="number" name="filtroDistancia" id="filtroDistancia" placeholder="Distancia">
                    <br><br>

                    <label for="filtro-tiempo">Tiempo:</label>
                    <select class="select-sign-btn" name="tiempo-signo" id="tiempo-signo">
                        <option value="menor">&lt;</option>
                        <option value="menor-igual">&le;</option>
                        <option value="igual">=</option>
                        <option value="no-igual">&ne;</option>
                        <option value="mayor">&gt;</option>
                        <option value="mayor-igual">&ge;</option>
                    </select>
                    <input type="number" name="filtroTiempo" id="filtroTiempo" placeholder="Tiempo">
                    <br><br>

                    <label for="filtro-velocidad">Velocidad:</label>
                    <select class="select-sign-btn" name="velocidad-signo" id="velocidad-signo">
                        <option value="menor">&lt;</option>
                        <option value="menor-igual">&le;</option>
                        <option value="igual">=</option>
                        <option value="no-igual">&ne;</option>
                        <option value="mayor">&gt;</option>
                        <option value="mayor-igual">&ge;</option>
                    </select>
                    <input type="number" name="filtroVelocidad" id="filtroVelocidad" placeholder="Velocidad">
                    <br><br>

                    <div id="filtros-todas-pdas" style="display: none;">
                        <label for="filtro-pda">PDA:</label>
                        <select class="select-sign-btn" name="pda-signo" id="pda-signo">
                            <option value="igual">=</option>
                            <option value="no-igual">&ne;</option>
                        </select>
                        <button type="button" class="select-btn" id="pdaBtnFilter" style="width: 70%;" disabled>Selecciona una PDA</button>
                        <div class="options" id="pdaOptionsFilter">
                            <!-- Las opciones se llenan dinámicamente con JavaScript -->
                        </div>
                    </div>

                    <div id="filtros-clus-diametro" style="display: none;">
                        <label for="filtro-diametro">Diámetro del cluster:</label>
                        <input type="number" name="filtroDiametroClus" id="filtroDiametroClus" placeholder="Diámetro">
                        <br>
                        <label for="filtro-pts-clus">Puntos máx del cluster:</label>
                        <input type="number" name="filtroNumPtsClus" id="filtroNumPtsClus" placeholder="Nº puntos">
                    </div>

                    <input type="hidden" name="pda" id="pdaInputFilter">

                    <br><br>
                    
                    <!-- Divisón botones de filtros -->
                    <div class="filter-actions"> 
                        <!-- Botón para aplicar filtros -->
                        <button class="accept-btn" id="btn-filtrar">
                            Filtrar
                        </button>
                        
                        <!-- Botón para borrar filtros -->
                        <button class="clear-btn" id="btn-limpiar-filtros">
                            Limpiar
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Columna del mapa -->
        <div class="column">
            <!-- Mapa -->
            <div class="map" id="mapa">
                <h2>Mapa</h2>
                <iframe id="iMap" frameborder="0"></iframe>
            </div>
        </div>
    </div>

    <!-- Tabla de resultados del codigo de unidad, PDA y fecha -->
    <div id="tabla-resultados" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Resultados — <span id="titulo-pda"></span> (<span id="titulo-fecha"></span>)</h2>
            <button class="generate-btn" id="descargarTabla">Descargar tabla</button>
        </div>
        <table id="tablaDatos">
            <thead>
                <tr>
                    <th>PDA</th>
                    <th>Fecha y Hora</th>
                    <!-- Calle, Nº  -->
                    <th>Calle</th>
                    <th>Longitud</th>
                    <th>Latitud</th>
                    <th>Distancia</th>
                    <th>Tiempo</th>
                    <th>Velocidad</th>
                    <th>Tipo</th>
                    <th>#p/i</th>
                    <th>#z</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div id="paginador" style="display:none; justify-content:center; align-items:center; gap:10px; margin-top:10px;">
            <button id="btn-prev" class="accept-btn">
                Anterior
            </button>
            <span id="pagina-info">Página 1 de 1</span>
            <button id="btn-next" class="accept-btn">
                Siguiente
            </button>
        </div>

    </div>
    <div id="loadingOverlay" style="display: flex;">
        <div class="loader"></div>
    </div>

{% endblock %}